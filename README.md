# Overview

CyberArk Conjur automatically secures secrets used by privileged users and machine identities.

[Learn more.](https://www.conjur.org)

# Installation

## Quick install with Google Cloud Marketplace

Get up and running with a few clicks!
Install this WordPress app to a Google Kubernetes Engine cluster using Google Cloud Marketplace.
Follow the [on-screen instructions](https://console.cloud.google.com/marketplace/details/cyberark/conjur-open-source).

## Command line instructions

### Prerequisites

#### Set up command-line tools

You'll need the following tools in your development environment:
- [gcloud](https://cloud.google.com/sdk/gcloud/)
- [kubectl](https://kubernetes.io/docs/reference/kubectl/overview/)
- [docker](https://docs.docker.com/install/)
- [git](https://git-scm.com/book/en/v2/Getting-Started-Installing-Git)

Configure `gcloud` as a Docker credential helper:

```shell
gcloud auth configure-docker
```

#### Create a Google Kubernetes Engine cluster

Create a new cluster from the command line:

```shell
export CLUSTER=wordpress-cluster
export ZONE=us-west1-a

gcloud container clusters create "$CLUSTER" --zone "$ZONE"
```

Configure `kubectl` to connect to the new cluster:

```shell
gcloud container clusters get-credentials "$CLUSTER" --zone "$ZONE"
```

#### Clone this repo

Clone this repo and the associated tools repo:

```shell
git clone --recursive https://github.com/cyberark/conjur-google-cloud-marketplace.git
git submodule sync --recursive
git submodule update --recursive --init --force
```


#### Install the Application resource definition

An Application resource is a collection of individual Kubernetes components,
such as Services, Deployments, and so on, that you can manage as a group.

To set up your cluster to understand Application resources, run the following command:

```shell
kubectl apply -f marketplace-k8s-app-tools/crd/*
```

You need to run this command once.

The Application resource is defined by the
[Kubernetes SIG-apps](https://github.com/kubernetes/community/tree/master/sig-apps)
community. The source code can be found on
[github.com/kubernetes-sigs/application](https://github.com/kubernetes-sigs/application).

### Install the Application

#### Configure the app with environment variables

Choose the instance name and namespace for the app.

```shell
export APP_INSTANCE_NAME=conjur-1
export NAMESPACE=conjur
```

Configure the container images:

```shell
export IMAGE_CONJUR="marketplace.gcr.io/cyberark/conjur:latest"
export IMAGE_POSTGRES="marketplace.gcr.io/cyberark/conjur/postgres:latest"
```

The images above are referenced by
[tag](https://docs.docker.com/engine/reference/commandline/tag). We recommend
that you pin each image to an immutable
[content digest](https://docs.docker.com/registry/spec/api/#content-digests).
This ensures that the installed application always uses the same images,
until you are ready to upgrade. To get the digest for the image, use the
following script:

```shell
for i in "IMAGE_CONJUR" "IMAGE_POSTGRES"; do
  repo=$(echo ${!i} | cut -d: -f1);
  digest=$(docker pull ${!i} | sed -n -e 's/Digest: //p');
  export $i="$repo@$digest";
  env | grep $i;
done
```

The Conjur data key is generated by the
deployer and does not need to be created
beforehand.

#### Create namespace in your Kubernetes cluster

We recommend running Conjur in its own namespace.
If you use a different namespace than the `default`, run the command below to create a new namespace:

```shell
kubectl create namespace "$NAMESPACE"
```

#### Install the application with Helm to your Kubernetes cluster

Use `helm` to deploy the application to your Kubernetes cluster:

If you'd like to use an external database, 
use the `helm` argument `--set conjur.databaseUrl='postgresql://[user[:password]@][netloc][:port][/dbname][?param1=value1&...]'` below. If `conjur.databaseUrl` is not specified, a postgres deployment and service are created.
See [conjur/values.yaml](conjur/values.yaml) for all available parameters and their defaults.

```shell
helm install ./conjur
```

#### View the app in the Google Cloud Console

To get the Console URL for your app, run the following command:

```shell
echo "https://console.cloud.google.com/kubernetes/application/${ZONE}/${CLUSTER}/${NAMESPACE}/${APP_INSTANCE_NAME}"
```

To view the app, open the URL in your browser.

